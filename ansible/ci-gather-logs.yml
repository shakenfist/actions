---
- hosts: localhost
  gather_facts: yes
  become: yes
  connection: local

  tasks:
    - name: Create artifacts directory
      file:
        path: /srv/github/artifacts
        state: directory
        mode: u+rwx,g+rwx,o+rwx

    - name: Set permissions in /srv/github
      file:
        path: /srv/github
        state: directory
        recurse: yes
        mode: ugo+rw

- hosts: all
  gather_facts: yes
  connection: ssh
  become: yes

  tasks:
    - name: Create bundle directory for node
      file:
        path: /srv/github/bundle/{{ ansible_fqdn }}
        state: directory
        mode: u+rw,g+rw,o-rwx
      delegate_to: localhost

    - name: Run clingwrap on node
      shell: |
        git clone https://github.com/shakenfist/clingwrap /srv/shakenfist/clingwrap
        /srv/shakenfist/venv/bin/pip3 install /srv/shakenfist/clingwrap
        /srv/shakenfist/venv/bin/clingwrap gather \
          --target shakenfist-ci-failure \
          --output /tmp/{{ ansible_fqdn }}.zip

    - name: Fix permissions
      file:
        path: /tmp/{{ ansible_fqdn }}.zip
        state: file
        mode: ugo+r

- hosts: all
  gather_facts: yes
  connection: ssh
  become: no

  tasks:
    - name: Collect clingwrap zip files
      fetch:
        src: "/tmp/{{ ansible_fqdn }}.zip"
        dest: /srv/github/{{ ansible_fqdn }}.zip
        flat: yes
        fail_on_missing: yes

    - name: Extract node zip file
      shell: |
        ls -lrth /srv/github/{{ ansible_fqdn }}.zip
        unzip -q /srv/github/{{ ansible_fqdn }}.zip -d /srv/github/bundle/{{ ansible_fqdn }}/ || true
        chmod -R ugo+rw /srv/github/
      delegate_to: localhost