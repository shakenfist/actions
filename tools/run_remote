#!/bin/bash

# $1 is the target machine
# $2+ is the command

if [ "${1}" == "localhost" ]; then
    exec ${@:2}
fi

if [ "${1}" == $(hostname) ]; then
    exec ${@:2}
fi

if [ -z "${baseuser}" ]; then
    baseuser="debian"
fi

script=${2}
if [ "%${copyscript}%" == "%true%" ]; then
    script="/tmp/"$(basename ${2})
    echo "Copying ${2} to ${script} on ${1}"
    scp -p -i /srv/github/id_ci -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        ${2} ${baseuser}@$1:${script}
fi

echo "Executing ${script} ${@:3} on ${1}"
ssh -i /srv/github/id_ci -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    ${baseuser}@$1 ${script} ${@:3}